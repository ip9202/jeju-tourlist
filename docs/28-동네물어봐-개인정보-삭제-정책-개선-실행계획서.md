# 동네물어봐 - 개인정보 삭제 정책 개선 실행계획서

## 📋 목차

1. [개요](#-개요)
2. [법적 배경](#-법적-배경)
3. [현재 상태 분석](#-현재-상태-분석)
4. [개선 전략](#-개선-전략)
5. [Phase 1: 접근 제어 강화](#phase-1-접근-제어-강화)
6. [Phase 2: Cascade 소프트 삭제 구현](#phase-2-cascade-소프트-삭제-구현)
7. [Phase 3: 자동 완전 삭제 배치 작업](#phase-3-자동-완전-삭제-배치-작업)
8. [Phase 4: 테스트 및 검증](#phase-4-테스트-및-검증)
9. [완료 체크리스트](#-완료-체크리스트)

---

## 🎯 개요

### 목표

개인정보보호법(PIPA)과 GDPR 요구사항을 완벽히 준수하는 개인정보 삭제 정책을 구현합니다.

### 핵심 요구사항

1. **한국 개인정보보호법**: 삭제된 개인정보가 "복구 또는 재생되지 않도록" 조치
2. **GDPR 규정**: "추가적 노력 없이 개인정보로 식별될 수 없어야 함"
3. **데이터 무결성**: 참조 무결성 유지하면서 데이터 정리
4. **규제 대응**: 법적 분쟁 시 근거 자료 유지 (감사 로그)

### 예상 효과

- ✅ 법률 준수: 100% 규제 요구사항 충족
- ✅ 사용자 신뢰: 개인정보 보호 정책 강화
- ✅ 운영 효율: 자동화된 데이터 정리 프로세스
- ✅ 법적 안정성: 규제 당국 감시 시 완벽한 대응

---

## 📜 법적 배경

### 한국 개인정보보호법 (개인정보보호법 제36조)

#### 제36조 제2항 - 정정·삭제 요구권

> **정보주체는 자신의 개인정보를 열람한 후 개인정보처리자에게 그 개인정보의 정정 또는 삭제를 요구할 수 있습니다.**

#### 제36조 제3항 - 삭제 조치 요구사항

> **개인정보를 삭제할 때에는 복구 또는 재생되지 아니하도록 조치하여야 합니다.**

**법적 해석**:

- 소프트삭제 허용 (단, 접근 제어 필수)
- 단순히 `status = "DELETED"` 설정은 불충분
- 삭제된 데이터에 대한 모든 접근 차단 필수

### GDPR - Right to Erasure (Article 17)

#### 삭제권 조건

```
대상자가 요청 시 다음 경우에 데이터 즉시 삭제:
├── 수집 목적 달성 후 불필요한 경우
├── 동의 철회 후 법적 근거 없는 경우
├── 이의 제기 및 합법적 이유 부재
└── 법적 의무에 따른 삭제 필요
```

#### 기술적 요구사항

```
"데이터가 추가적인 노력 없이 개인정보로 식별될 수 없어야 함"

기술적 구현:
├── 검색 결과에서 비활성화 (Search Validation)
├── 백업/아카이브에서 제거 (Backup Verification)
├── 참조 데이터 정정 (Cascade Operations)
└── 감사 추적 (Audit Trail Maintenance)
```

### 비교 분석

| 항목                 | PIPA (한국)               | GDPR (유럽)              | 우리 구현                       |
| -------------------- | ------------------------- | ------------------------ | ------------------------------- |
| **기술 방법**        | 미규정 (기술중립)         | 미규정 (기술중립)        | 하이브리드 (Soft + Hard Delete) |
| **소프트삭제 허용**  | ✅ 가능 (접근제어 필수)   | ✅ 가능 (완전 숨김 필수) | ✅ 단계별 구현                  |
| **데이터 보존 기간** | 불필요한 데이터 즉시 삭제 | 90일 내 삭제             | 30일 유예 + 자동 삭제           |
| **감사 증거 유지**   | 필요                      | 필요                     | ✅ 감시 로그 유지               |

---

## 🔍 현재 상태 분석

### 문제점

#### 1. 단순 소프트삭제만 구현

```typescript
// 현재 구현 (문제 있음)
async delete(id: string): Promise<Question> {
  return await this.prisma.question.update({
    where: { id },
    data: {
      status: "DELETED",  // 이것만으로는 불충분
      updatedAt: new Date(),
    },
  });
}
```

**문제**:

- ❌ 삭제된 데이터를 쿼리로 조회 가능 (권한 체크 불완전)
- ❌ 관리자가 의도적으로 조회 가능 (법적 위험)
- ❌ 백업/캐시에 여전히 존재

#### 2. Cascade 물리삭제 구현

```typescript
// 현재 구현 (문제 있음)
// Prisma: onDelete: Cascade (물리 삭제)
answer     Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
```

**문제**:

- ❌ 질문 삭제 시 답변/댓글도 즉시 물리 삭제
- ❌ 데이터 복구 불가능
- ❌ 참조 무결성 조회 불가

#### 3. 접근 제어 미흡

```typescript
// 현재 구현 (문제 있음)
async getQuestion(id: string) {
  // DELETED 상태 자동 필터링 없음
  return await this.prisma.question.findUnique({
    where: { id },
  });
  // 관리자, 일반 사용자 모두 조회 가능한 상황 발생 가능
}
```

**문제**:

- ❌ DELETED 상태 자동 필터링 없음
- ❌ 관리자 접근 제어 미정의
- ❌ 감사 로그 없음

---

## 🏗️ 개선 전략

### 이원화 삭제 정책: Soft Delete + Hard Delete

```
삭제 요청
    ↓
[1단계] 소프트삭제 (Status = "DELETED")
├── 데이터 보존 (무결성 유지)
├── 접근 차단 (쿼리에서 자동 제외)
├── 감사 로그 기록
└── 법적 분쟁 대응 자료 유지 (30일)
    ↓
[30일 대기]
├── 사용자가 복구 요청 시 되돌릴 수 있음
└── 법적 요구사항 확인 기간
    ↓
[2단계] 물리삭제 (DELETE - 완전 삭제)
├── 배치 작업으로 자동 실행
├── 삭제 감사 로그 최종 기록
└── 완전히 복구 불가능
```

### Phase별 구현 전략

#### Phase 1: 접근 제어 강화 (즉시)

- 모든 GET 쿼리에 자동 필터링 추가
- 삭제된 데이터는 조회 불가능하도록 보장
- 삭제 요청 감시 로그 기록

#### Phase 2: Cascade 소프트삭제 (1-2일)

- 현재 물리삭제를 소프트삭제로 변경
- 질문 삭제 시 관련 데이터(답변, 댓글) 모두 소프트삭제
- 트랜잭션으로 데이터 일관성 보장

#### Phase 3: 자동 완전 삭제 배치 (1일)

- 30일 경과한 DELETED 데이터 자동 삭제
- 매일 자정에 실행
- 삭제 전 최종 감시 로그 기록

#### Phase 4: 테스트 및 검증 (1-2일)

- 모든 단위/통합 테스트 작성
- E2E 테스트로 전체 플로우 검증
- 법적 요구사항 체크리스트 검증

---

## Phase 1: 접근 제어 강화

### 1.1 삭제된 데이터 자동 필터링

#### 1.1.1 Repository 레벨 필터링

- [ ] 질문 조회 메서드에 `status !== "DELETED"` 필터 추가
  ```typescript
  async getQuestion(id: string) {
    const question = await this.prisma.question.findUnique({
      where: { id },
    });

    if (!question || question.status === "DELETED") {
      throw new Error("존재하지 않는 질문입니다");
    }
    return question;
  }
  ```
- [ ] 답변 조회 메서드에 필터 추가
- [ ] 댓글 조회 메서드에 필터 추가
- [ ] 목록 조회 메서드 (페이지네이션 포함)에 필터 추가
- [ ] **Lint/Error 체크**: Repository 메서드 유닛 테스트 통과

#### 1.1.2 API 레벨 응답 필터링

- [ ] 질문 API (`GET /api/questions/:id`)에서 DELETED 상태 체크
- [ ] 목록 API (`GET /api/questions`)에서 DELETED 자동 제외
- [ ] 답변 API에서 DELETED 자동 제외
- [ ] 댓글 API에서 DELETED 자동 제외
- [ ] **Lint/Error 체크**: API 통합 테스트 통과

#### 1.1.3 캐시 레벨 필터링

- [ ] Redis 캐시에서 DELETED 데이터 제외
- [ ] 캐시 무효화 정책 업데이트 (삭제 시 캐시 제거)
- [ ] **Lint/Error 체크**: 캐시 일관성 테스트 통과

### 1.2 삭제 요청 감시 로깅

#### 1.2.1 AuditLog 테이블 생성

- [ ] Prisma 스키마에 AuditLog 모델 추가
  ```typescript
  model AuditLog {
    id        String   @id @default(cuid())
    action    String   // "DELETE", "RESTORE", etc
    targetType String  // "QUESTION", "ANSWER", "COMMENT"
    targetId  String
    userId    String   // 작업을 수행한 사용자
    reason    String?  // 삭제 이유
    status    String   // "DELETED", "RESTORED", "PERMANENTLY_DELETED"
    details   Json?    // 추가 정보
    createdAt DateTime @default(now())
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  }
  ```
- [ ] 마이그레이션 생성 및 적용
- [ ] **Lint/Error 체크**: 스키마 마이그레이션 성공

#### 1.2.2 AuditLogService 구현

- [ ] AuditLogService 클래스 생성
- [ ] deleteQuestion 호출 시 AuditLog 기록
- [ ] deleteAnswer 호출 시 AuditLog 기록
- [ ] deleteComment 호출 시 AuditLog 기록
- [ ] **Lint/Error 체크**: 감시 로깅 유닛 테스트 통과

#### 1.2.3 삭제 감시 정책

- [ ] 영구 삭제 시 2개월 이상 보관 요구
- [ ] IP 주소, User-Agent 등 기술적 정보 기록
- [ ] 삭제 사유 및 근거 자료 기록
- [ ] **Lint/Error 체크**: 감시 로그 조회 기능 테스트 통과

### 1.3 관리자 접근 제어

#### 1.3.1 관리자용 삭제된 데이터 조회 API

- [ ] `GET /api/admin/deleted-questions` 관리자 전용 API
- [ ] `GET /api/admin/deleted-answers` 관리자 전용 API
- [ ] `GET /api/admin/deleted-comments` 관리자 전용 API
- [ ] 역할 기반 접근 제어 (RBAC) 적용
- [ ] **Lint/Error 체크**: 관리자 API 권한 테스트 통과

#### 1.3.2 삭제 데이터 복구 기능

- [ ] `POST /api/admin/restore-question/:id` API 구현
- [ ] `POST /api/admin/restore-answer/:id` API 구현
- [ ] 관리자만 30일 내 복구 가능
- [ ] 복구 감시 로그 기록
- [ ] **Lint/Error 체크**: 복구 기능 통합 테스트 통과

---

## Phase 2: Cascade 소프트 삭제 구현

### 2.1 Prisma 스키마 업데이트

#### 2.1.1 Cascade 관계 검토

- [ ] `Answer.question` 관계 검토: 현재 `onDelete: Cascade` (물리 삭제)
  ```typescript
  // 현재 (문제)
  question     Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  ```
- [ ] `AnswerComment.answer` 관계 검토
- [ ] `AnswerComment.parent` 관계 검토 (계층형 댓글)
- [ ] **Lint/Error 체크**: 스키마 검토 완료

#### 2.1.2 참고사항: Prisma Cascade 제약

Prisma는 `onDelete: Cascade`만으로 소프트삭제를 자동화할 수 없습니다.
→ 수동으로 비즈니스 로직에서 구현해야 함

### 2.2 질문 삭제 서비스 재구현

#### 2.2.1 TransactionManager 구현

- [ ] `QuestionService.deleteQuestion` 메서드 재구현

  ```typescript
  async deleteQuestion(id: string, userId: string) {
    // 1. 질문 소유권 확인
    await this.checkQuestionOwnership(id, userId);

    // 2. 트랜잭션으로 모든 관련 데이터 소프트 삭제
    return await this.prisma.$transaction([
      // 질문 삭제
      this.prisma.question.update({
        where: { id },
        data: { status: "DELETED", updatedAt: new Date() }
      }),
      // 모든 답변 삭제
      this.prisma.answer.updateMany({
        where: { questionId: id },
        data: { status: "DELETED", updatedAt: new Date() }
      }),
      // 모든 댓글 삭제 (답변 경유)
      this.prisma.answerComment.updateMany({
        where: { answer: { questionId: id } },
        data: { status: "DELETED", updatedAt: new Date() }
      }),
      // 좋아요/북마크 물리 삭제
      this.prisma.questionLike.deleteMany({
        where: { questionId: id }
      }),
      this.prisma.bookmark.deleteMany({
        where: { questionId: id }
      })
    ]);
  }
  ```

- [ ] **Lint/Error 체크**: 트랜잭션 로직 유닛 테스트 통과

#### 2.2.2 삭제 감시 로그 통합

- [ ] deleteQuestion 호출 시 AuditLog 기록
- [ ] 질문, 답변, 댓글 각각에 대해 삭제 로그 기록
- [ ] 트랜잭션 성공 후에만 로그 확정
- [ ] **Lint/Error 체크**: 트랜잭션 + 로깅 통합 테스트 통과

### 2.3 답변 삭제 서비스 재구현

#### 2.3.1 AnswerService.deleteAnswer 구현

- [ ] 답변 삭제 시 해당 답변의 모든 댓글도 소프트 삭제

  ```typescript
  async deleteAnswer(id: string, userId: string) {
    // 1. 답변 소유권 확인
    await this.checkAnswerOwnership(id, userId);

    // 2. 트랜잭션
    return await this.prisma.$transaction([
      // 댓글 삭제
      this.prisma.answerComment.updateMany({
        where: { answerId: id },
        data: { status: "DELETED", updatedAt: new Date() }
      }),
      // 답변 삭제
      this.prisma.answer.update({
        where: { id },
        data: { status: "DELETED", updatedAt: new Date() }
      }),
      // 좋아요 물리 삭제
      this.prisma.answerLike.deleteMany({
        where: { answerId: id }
      })
    ]);
  }
  ```

- [ ] **Lint/Error 체크**: 답변 삭제 통합 테스트 통과

#### 2.3.2 계층형 댓글 연쇄 삭제

- [ ] 댓글 삭제 시 하위 대댓글도 소프트 삭제

  ```typescript
  async deleteComment(id: string, userId: string) {
    // 1. 댓글 소유권 확인
    await this.checkCommentOwnership(id, userId);

    // 2. 하위 댓글 모두 찾기
    const allComments = await this.findAllDescendants(id);

    // 3. 트랜잭션
    return await this.prisma.$transaction([
      // 모든 댓글 삭제
      this.prisma.answerComment.updateMany({
        where: { id: { in: allComments.map(c => c.id) } },
        data: { status: "DELETED", updatedAt: new Date() }
      }),
      // 좋아요 물리 삭제
      this.prisma.answerCommentLike.deleteMany({
        where: { commentId: { in: allComments.map(c => c.id) } }
      })
    ]);
  }
  ```

- [ ] **Lint/Error 체크**: 계층형 댓글 삭제 테스트 통과

### 2.4 관계 데이터 정정

#### 2.4.1 참조 무결성 유지

- [ ] 질문 삭제 시 `acceptedAnswerId` 초기화
- [ ] 답변 선택 취소 가능하도록 설정
- [ ] 외래키 제약 검증
- [ ] **Lint/Error 체크**: 참조 무결성 테스트 통과

#### 2.4.2 통계 업데이트

- [ ] 질문 삭제 시 `answerCount` 감소 처리
- [ ] 답변 삭제 시 질문의 `answerCount` 감소
- [ ] 댓글 삭제는 카운트 영향 없음
- [ ] **Lint/Error 체크**: 통계 일관성 테스트 통과

---

## Phase 3: 자동 완전 삭제 배치 작업

### 3.1 배치 작업 구현

#### 3.1.1 PermanentDeleteService 구현

- [ ] DeletedDataCleanupService 클래스 생성

  ```typescript
  export class DeletedDataCleanupService {
    constructor(private prisma: PrismaClient) {}

    async permanentlyDeleteOldData(daysThreshold: number = 30) {
      const cutoffDate = new Date(
        Date.now() - daysThreshold * 24 * 60 * 60 * 1000
      );

      return await this.prisma.$transaction([
        // 1. 댓글 완전 삭제
        this.prisma.answerComment.deleteMany({
          where: {
            status: "DELETED",
            updatedAt: { lt: cutoffDate },
          },
        }),
        // 2. 답변 완전 삭제
        this.prisma.answer.deleteMany({
          where: {
            status: "DELETED",
            updatedAt: { lt: cutoffDate },
          },
        }),
        // 3. 질문 완전 삭제
        this.prisma.question.deleteMany({
          where: {
            status: "DELETED",
            updatedAt: { lt: cutoffDate },
          },
        }),
      ]);
    }
  }
  ```

- [ ] **Lint/Error 체크**: 완전 삭제 로직 유닛 테스트 통과

#### 3.1.2 배치 스케줄 설정

- [ ] node-cron 또는 AWS Lambda로 스케줄 설정

  ```typescript
  // apps/api/src/jobs/deleteCleanupJob.ts
  import cron from "node-cron";

  export function scheduleDeleteCleanupJob() {
    // 매일 자정(KST)에 실행
    cron.schedule("0 0 * * *", async () => {
      console.log("Starting permanent delete cleanup...");
      const service = new DeletedDataCleanupService(prisma);
      const result = await service.permanentlyDeleteOldData(30);
      console.log(`Cleanup completed: ${JSON.stringify(result)}`);
    });
  }
  ```

- [ ] Express 애플리케이션 시작 시 스케줄 등록
- [ ] **Lint/Error 체크**: 스케줄 테스트 완료

#### 3.1.3 배치 실행 로그

- [ ] DeleteCleanupLog 테이블 생성
  ```typescript
  model DeleteCleanupLog {
    id              String   @id @default(cuid())
    status          String   // "STARTED", "SUCCESS", "FAILED"
    startedAt       DateTime @default(now())
    completedAt     DateTime?
    deletedQuestions Int?
    deletedAnswers  Int?
    deletedComments Int?
    errorMessage    String?
    durationMs      Int?
  }
  ```
- [ ] 마이그레이션 생성 및 적용
- [ ] **Lint/Error 체크**: 배치 로그 테이블 생성 성공

#### 3.1.4 배치 실행 감시 로그

- [ ] 완전 삭제 전에 AuditLog에 최종 기록
  ```typescript
  await this.auditLogService.log({
    action: "PERMANENTLY_DELETE",
    targetType: "QUESTION",
    targetId: question.id,
    status: "PERMANENTLY_DELETED",
    reason: "Automatic cleanup after 30 days",
  });
  ```
- [ ] 삭제 실패 시 알림 전송
- [ ] **Lint/Error 체크**: 감시 로그 기록 테스트 통과

### 3.2 수동 영구 삭제 기능

#### 3.2.1 관리자 수동 영구 삭제 API

- [ ] `DELETE /api/admin/permanently-delete-question/:id` API
- [ ] `DELETE /api/admin/permanently-delete-answer/:id` API
- [ ] 관리자만 접근 가능 (RBAC)
- [ ] 영구 삭제 전 최종 확인 로그 기록
- [ ] **Lint/Error 체크**: 관리자 API 권한 테스트 통과

#### 3.2.2 GDPR 요청 처리

- [ ] "Right to be Forgotten" 요청 처리 프로세스
- [ ] 사용자 요청 30일 내 영구 삭제 보장
- [ ] 사용자 요청 로그 기록
- [ ] **Lint/Error 체크**: GDPR 프로세스 테스트 통과

---

## Phase 4: 테스트 및 검증

### 4.1 단위 테스트

#### 4.1.1 Repository 테스트

- [ ] `getQuestion` - DELETED 상태 자동 필터링
  ```typescript
  it("should exclude deleted questions", async () => {
    const deletedQuestion = await createQuestion({ status: "DELETED" });
    const result = await questionRepository.getQuestion(deletedQuestion.id);
    expect(result).toBeNull(); // 또는 에러 throw
  });
  ```
- [ ] `listQuestions` - 페이지네이션에서 DELETED 제외
- [ ] `getAnswer` - DELETED 답변 조회 불가
- [ ] `listAnswers` - DELETED 답변 제외
- [ ] `getComment` - DELETED 댓글 조회 불가
- [ ] **Lint/Error 체크**: Repository 테스트 100% 통과

#### 4.1.2 Service 테스트

- [ ] `deleteQuestion` - 질문/답변/댓글 모두 소프트 삭제

  ```typescript
  it("should soft delete question and related data", async () => {
    const question = await createQuestion();
    const answer = await createAnswer({ questionId: question.id });
    const comment = await createComment({ answerId: answer.id });

    await questionService.deleteQuestion(question.id, userId);

    const deletedQ = await prisma.question.findUnique({
      where: { id: question.id },
    });
    expect(deletedQ.status).toBe("DELETED");

    const deletedA = await prisma.answer.findUnique({
      where: { id: answer.id },
    });
    expect(deletedA.status).toBe("DELETED");

    const deletedC = await prisma.answerComment.findUnique({
      where: { id: comment.id },
    });
    expect(deletedC.status).toBe("DELETED");
  });
  ```

- [ ] `deleteAnswer` - 답변/댓글 소프트 삭제
- [ ] `deleteComment` - 댓글/대댓글 소프트 삭제
- [ ] 트랜잭션 원자성 테스트 (일부 실패 시 롤백)
- [ ] **Lint/Error 체크**: Service 테스트 100% 통과

#### 4.1.3 AuditLog 테스트

- [ ] 삭제 요청 시 로그 기록 확인
- [ ] 로그에 사용자ID, 타겟ID, 삭제 시간 포함 확인
- [ ] 로그 삭제 불가능 (변조 방지) 테스트
- [ ] **Lint/Error 체크**: 감시 로그 테스트 통과

### 4.2 통합 테스트

#### 4.2.1 API 통합 테스트

- [ ] `DELETE /api/questions/:id` - 삭제 권한 확인

  ```typescript
  it("should delete question only if user is author", async () => {
    const question = await createQuestion({ authorId: user1.id });
    const response = await request(app)
      .delete(`/api/questions/${question.id}`)
      .set("Authorization", `Bearer ${user2Token}`);

    expect(response.status).toBe(403); // Forbidden
  });
  ```

- [ ] `DELETE /api/answers/:id` - 답변 삭제 권한 확인
- [ ] `GET /api/questions/:id` - 삭제된 질문 조회 불가
- [ ] `GET /api/questions/:id/answers` - 삭제된 답변 제외
- [ ] **Lint/Error 체크**: API 통합 테스트 100% 통과

#### 4.2.2 배치 작업 테스트

- [ ] 배치 작업 실행 후 30일 이상 경과한 DELETED 데이터 영구 삭제 확인

  ```typescript
  it("should permanently delete data older than 30 days", async () => {
    // 30일 이상 전에 삭제된 데이터 생성
    const oldDeletedQuestion = await prisma.question.create({
      data: {
        ...questionData,
        status: "DELETED",
        updatedAt: new Date("2024-09-24"),
      },
    });

    await cleanupService.permanentlyDeleteOldData(30);

    const result = await prisma.question.findUnique({
      where: { id: oldDeletedQuestion.id },
    });
    expect(result).toBeNull();
  });
  ```

- [ ] 배치 작업 실행 후 30일 미만 DELETED 데이터는 유지 확인
- [ ] DeleteCleanupLog 기록 확인
- [ ] **Lint/Error 체크**: 배치 작업 통합 테스트 통과

### 4.3 E2E 테스트

#### 4.3.1 전체 삭제 플로우 테스트

- [ ] 사용자가 질문 삭제 → 소프트 삭제 확인 → 다른 사용자가 조회 불가 확인
- [ ] 사용자가 답변 삭제 → 같은 질문의 다른 답변은 유지 확인
- [ ] 관리자가 삭제된 질문 복구 → 다시 조회 가능 확인
- [ ] **Lint/Error 체크**: E2E 테스트 100% 통과

#### 4.3.2 법적 요구사항 검증

- [ ] 삭제 후 30일 내 감사 로그 존재 확인 (PIPA 요구)
- [ ] 완전 삭제 후 데이터 복구 불가능 확인 (GDPR 요구)
- [ ] 삭제 요청자 확인 (사용자 또는 권한 있는 관리자)
- [ ] **Lint/Error 체크**: 법적 검증 체크리스트 100% 충족

### 4.4 성능 및 부하 테스트

#### 4.4.1 대량 삭제 성능 테스트

- [ ] 1000개 질문 및 관련 데이터(답변/댓글) 일괄 삭제 성능 테스트
  ```typescript
  it("should delete 1000 questions with related data in reasonable time", async () => {
    // 시간 측정
    const start = performance.now();

    for (let i = 0; i < 1000; i++) {
      const question = await createQuestion();
      await questionService.deleteQuestion(question.id, userId);
    }

    const end = performance.now();
    const durationMs = end - start;

    // 1000개 삭제가 30초 이내 완료
    expect(durationMs).toBeLessThan(30000);
  });
  ```
- [ ] 배치 작업 성능 테스트 (10만 개 DELETED 데이터 영구 삭제)
- [ ] 메모리 누수 테스트
- [ ] **Lint/Error 체크**: 성능 기준 충족 (P99 < 1초)

#### 4.4.2 동시성 테스트

- [ ] 동시에 같은 질문 삭제 요청 → 트랜잭션 원자성 확인
- [ ] 동시에 삭제 + 복구 요청 → 일관성 확인
- [ ] **Lint/Error 체크**: 동시성 테스트 통과

### 4.5 보안 테스트

#### 4.5.1 접근 제어 테스트

- [ ] 일반 사용자가 삭제된 데이터 조회 불가 확인
- [ ] 일반 사용자가 다른 사용자 데이터 삭제 불가 확인
- [ ] 관리자만 복구 기능 사용 가능 확인
- [ ] **Lint/Error 체크**: 보안 테스트 100% 통과

#### 4.5.2 감시 로그 위변조 방지

- [ ] AuditLog 레코드 삭제 방지
- [ ] AuditLog 타임스탬프 변경 불가능 확인
- [ ] 감시 로그 암호화 적용
- [ ] **Lint/Error 체크**: 보안 강화 완료

---

## ✅ 완료 체크리스트

### Phase 1: 접근 제어 강화 (즉시)

#### 1.1 삭제된 데이터 자동 필터링

- [ ] ✅ Repository 레벨 필터링 구현
- [ ] ✅ API 레벨 응답 필터링 구현
- [ ] ✅ 캐시 레벨 필터링 구현
- [ ] ✅ Lint/Error 체크 통과

#### 1.2 삭제 요청 감시 로깅

- [ ] ✅ AuditLog 테이블 생성
- [ ] ✅ AuditLogService 구현
- [ ] ✅ 삭제 감시 정책 수립
- [ ] ✅ Lint/Error 체크 통과

#### 1.3 관리자 접근 제어

- [ ] ✅ 관리자용 API 구현
- [ ] ✅ 복구 기능 구현
- [ ] ✅ Lint/Error 체크 통과

**Phase 1 완료**: ☐ 모든 항목 완료 시 100% ✅

---

### Phase 2: Cascade 소프트 삭제 구현 (1-2일)

#### 2.1 Prisma 스키마 업데이트

- [ ] ✅ Cascade 관계 검토 완료
- [ ] ✅ Lint/Error 체크 통과

#### 2.2 질문 삭제 서비스 재구현

- [ ] ✅ TransactionManager 구현
- [ ] ✅ 삭제 감시 로그 통합
- [ ] ✅ Lint/Error 체크 통과

#### 2.3 답변 삭제 서비스 재구현

- [ ] ✅ AnswerService.deleteAnswer 구현
- [ ] ✅ 계층형 댓글 연쇄 삭제
- [ ] ✅ Lint/Error 체크 통과

#### 2.4 관계 데이터 정정

- [ ] ✅ 참조 무결성 유지
- [ ] ✅ 통계 업데이트
- [ ] ✅ Lint/Error 체크 통과

**Phase 2 완료**: ☐ 모든 항목 완료 시 100% ✅

---

### Phase 3: 자동 완전 삭제 배치 작업 (1일)

#### 3.1 배치 작업 구현

- [ ] ✅ DeletedDataCleanupService 구현
- [ ] ✅ 배치 스케줄 설정
- [ ] ✅ 배치 실행 로그 구현
- [ ] ✅ 배치 실행 감시 로그
- [ ] ✅ Lint/Error 체크 통과

#### 3.2 수동 영구 삭제 기능

- [ ] ✅ 관리자 수동 영구 삭제 API
- [ ] ✅ GDPR 요청 처리
- [ ] ✅ Lint/Error 체크 통과

**Phase 3 완료**: ☐ 모든 항목 완료 시 100% ✅

---

### Phase 4: 테스트 및 검증 (1-2일)

#### 4.1 단위 테스트

- [ ] ✅ Repository 테스트 완료 (100% 통과)
- [ ] ✅ Service 테스트 완료 (100% 통과)
- [ ] ✅ AuditLog 테스트 완료 (100% 통과)
- [ ] ✅ Lint/Error 체크 통과

#### 4.2 통합 테스트

- [ ] ✅ API 통합 테스트 완료 (100% 통과)
- [ ] ✅ 배치 작업 통합 테스트 완료 (100% 통과)
- [ ] ✅ Lint/Error 체크 통과

#### 4.3 E2E 테스트

- [ ] ✅ 전체 삭제 플로우 테스트 완료 (100% 통과)
- [ ] ✅ 법적 요구사항 검증 완료 (100% 충족)
- [ ] ✅ Lint/Error 체크 통과

#### 4.4 성능 및 부하 테스트

- [ ] ✅ 대량 삭제 성능 테스트 통과
- [ ] ✅ 동시성 테스트 통과
- [ ] ✅ Lint/Error 체크 통과

#### 4.5 보안 테스트

- [ ] ✅ 접근 제어 테스트 통과 (100%)
- [ ] ✅ 감시 로그 위변조 방지 테스트 통과
- [ ] ✅ Lint/Error 체크 통과

**Phase 4 완료**: ☐ 모든 항목 완료 시 100% ✅

---

## 📊 전체 완료 진행도

### 단계별 완료 상태

| Phase    | 작업               | 예상 소요 | 상태  | 진행률 |
| -------- | ------------------ | --------- | ----- | ------ |
| 1        | 접근 제어 강화     | 1일       | ☐     | 0%     |
| 2        | Cascade 소프트삭제 | 1-2일     | ☐     | 0%     |
| 3        | 자동 완전삭제      | 1일       | ☐     | 0%     |
| 4        | 테스트 및 검증     | 1-2일     | ☐     | 0%     |
| **전체** | **4개 Phase**      | **4-6일** | **☐** | **0%** |

### 질량 관리 체크포인트

#### 매 Phase 완료시

- [ ] 모든 ESLint 에러 0개
- [ ] 모든 TypeScript 컴파일 에러 0개
- [ ] 신규 테스트 100% 통과
- [ ] 기존 테스트 회귀 없음
- [ ] Git 커밋 완료

#### 전체 완료시

- [ ] 모든 4개 Phase 100% 완료
- [ ] 단위 테스트 커버리지 90% 이상
- [ ] 통합 테스트 100% 통과
- [ ] E2E 테스트 100% 통과
- [ ] 법적 요구사항 100% 준수 검증
- [ ] **✅ 100% 완료**

---

## 🚀 시작 가이드

### 즉시 시작할 수 있는 첫 번째 단계

**Step 1: 현재 상태 백업**

```bash
# 데이터베이스 백업
pg_dump jeju_tourlist > backup_$(date +%s).sql

# Git 커밋
git add .
git commit -m "backup: before personal data deletion policy improvement"
git push
```

**Step 2: Phase 1 시작**

```bash
# Phase 1.1: Repository 수정
# apps/api/src/services/question/QuestionRepository.ts 열기
# getQuestion 메서드에 status 필터링 추가
```

**Step 3: 테스트 실행**

```bash
# Phase 1 완료 후
npm run test -- questionRepository
npm run type-check
npm run lint
```

---

## 📝 참고자료

### 법적 참고

1. **개인정보보호법**
   - 제36조: 정정·삭제 요구권
   - 제37조: 처리정지 요구권

2. **GDPR**
   - Article 17: Right to erasure ('right to be forgotten')
   - Article 5: 데이터 최소화 원칙

3. **한국 개인정보보호위원회**
   - 표준 개인정보 보호지침
   - 개인정보보호실무가이드

### 기술적 참고

1. **Prisma**
   - [$transaction](https://www.prisma.io/docs/reference/api-reference/prisma-client-reference#transaction)
   - 조건부 업데이트

2. **Node.js Cron**
   - [node-cron](https://github.com/kelektiv/node-cron)
   - 스케줄 표현식

---

**최종 업데이트**: 2025-10-24 (한국시간)  
**상태**: 🟡 준비 중 (Phase 1 시작 예정)  
**총 예상 소요 시간**: 4-6일
